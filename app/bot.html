<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workshop Bot</title>
  <script id="sap-ui-bootstrap"
    src="https://sdk.openui5.org/resources/sap-ui-core.js"
    data-sap-ui-theme="sap_horizon"
    data-sap-ui-libs="sap.m, sap.ui.core"
    data-sap-ui-compatVersion="edge"
    data-sap-ui-async="true"
    data-sap-ui-onInit="onInit">
  </script>
  <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
  <style>
    /* Position n8n chat inside our container instead of floating */
    #n8n-chat-container {
      width: 100%;
      height: calc(100vh - 6rem);
      position: relative;
    }
    /* Override n8n chat to fill container */
    #n8n-chat-container .chat-wrapper,
    #n8n-chat-container > div {
      position: absolute !important;
      inset: 0 !important;
      width: 100% !important;
      height: 100% !important;
      max-height: 100% !important;
      border-radius: 0 !important;
      box-shadow: none !important;
    }
  </style>
  <script>
    function onInit() {
      // Fetch app info to get the n8n chat URL (configurable via env var)
      fetch('/api/info')
        .then(r => r.json())
        .then(data => buildUI(data))
        .catch(() => buildUI({}));
    }

    function buildUI(info) {
      const page = new sap.m.Page({
        title: "Workshop Bot",
        showNavButton: true,
        navButtonPress: function() { window.location.href = '/index.html'; },
        headerContent: [
          new sap.m.Text({ text: "Powered by n8n" }).addStyleClass("sapUiSmallMarginEnd")
        ],
        content: [
          new sap.ui.core.HTML({
            content: '<div id="n8n-chat-container"></div>'
          })
        ]
      });

      const shell = new sap.m.Shell({ app: page });
      shell.placeAt("content");

      // Load n8n chat widget after UI is rendered
      setTimeout(() => {
        const chatUrl = info.n8nChatUrl || 'https://n8n-dev.container.dev.local/webhook/0a7daf42-4283-4b04-8b1a-4a0d60186e49/chat';
        loadN8nChat(chatUrl);
      }, 500);
    }

    function loadN8nChat(webhookUrl) {
      import('https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js')
        .then(module => {
          module.createChat({
            webhookUrl: webhookUrl,
            target: '#n8n-chat-container',
            mode: 'fullscreen',
            chatInputKey: 'chatInput',
            metadata: {},
            showWelcomeScreen: false,
            initialMessages: [
              'Hello! ðŸ‘‹ I\'m the Workshop Bot running on our K8s cluster.',
              "Ask me anything about SAP documentation and I'll be happy to help!"
            ],
            i18n: {
              en: {
                title: 'Workshop Bot',
                subtitle: 'Running on container.dev.local via n8n',
                inputPlaceholder: 'Type your message...',
              }
            }
          });
        })
        .catch(err => {
          // Fallback if CDN is not accessible
          const container = document.getElementById('n8n-chat-container');
          if (container) {
            container.innerHTML = `
              <div style="padding: 2rem; text-align: center; color: #666;">
                <h3>Chat widget could not be loaded</h3>
                <p>The n8n chat CDN might not be accessible from your network.</p>
                <p>You can access the bot directly at:</p>
                <a href="${webhookUrl}" target="_blank" style="color: #0070f2;">${webhookUrl}</a>
                <br/><br/>
                <p style="font-size: 0.85rem; color: #999;">Error: ${err.message}</p>
              </div>
            `;
          }
        });
    }
  </script>
</head>
<body class="sapUiBody" id="content"></body>
</html>
